name: Manual Build & Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag name for release (e.g. v2.2.0)'
        required: false
        default: 'test-build'

jobs:
  # =========================================================
  # JOB 1: WINDOWS
  # =========================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtpdf'  # Request PDF module here too, just in case

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # FIXED: Uses 7zip (pre-installed) to extract exactly where we want
      - name: Download Poppler Dependency
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/oschwartz10612/poppler-windows/releases/download/v21.11.0-0/Release-21.11.0-0.zip" -OutFile "poppler.zip"
          # Extract directly to the folder name we want (no renaming needed)
          7z x poppler.zip -oppoppler-21.11.0
          # Move contents up one level if 7zip nested them (Safe check)
          if (Test-Path "poppler-21.11.0\poppler-21.11.0") {
             Move-Item -Path "poppler-21.11.0\poppler-21.11.0\*" -Destination "poppler-21.11.0"
             Remove-Item -Path "poppler-21.11.0\poppler-21.11.0"
          }

      - name: Build with QMake
        shell: cmd
        run: |
          mkdir build
          cd build
          qmake ..\tikzit.pro "CONFIG+=release"
          nmake

      - name: Package
        shell: cmd
        run: |
          choco install 7zip
          .\deploy-win.bat

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TikZiT-Windows
          path: dist/tikzit.zip

  # =========================================================
  # JOB 2: MACOS
  # =========================================================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'
          # FIXED: Explicitly ask for the PDF module
          modules: 'qtpdf'

      - name: Build with QMake
        run: |
          mkdir build
          cd build
          qmake ../tikzit.pro CONFIG+=release
          make -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          chmod +x deploy-osx.sh
          ./deploy-osx.sh

      - name: Upload Mac Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TikZiT-macOS
          path: tikzit.dmg

  # =========================================================
  # JOB 3: LINUX
  # =========================================================
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      # FIXED: Added 'sudo' to all apt commands
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git pkg-config wget ca-certificates \
            flex bison qmake6 \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools qt6-pdf-dev \
            libqt6svg6-dev libpoppler-dev \
            libx11-xcb1 libxkbcommon-x11-0 libxrender1 \
            libxcb-cursor0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-randr0 libxcb-render-util0 libxcb-shape0 libxcb-shm0 \
            libxcb-sync1 libxcb-xfixes0 libxcb-xinerama0 libxcb-xkb1

      - name: Build with QMake
        run: |
          mkdir build
          cd build
          qmake6 ../tikzit.pro
          make -j$(nproc)

      - name: Package (AppImage)
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          export QMAKE=/usr/bin/qmake6
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --executable build/tikzit --icon share/tikzit.svg --desktop-file share/tikzit.desktop --plugin qt --output appimage

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TikZiT-Linux
          path: TikZiT*.AppImage