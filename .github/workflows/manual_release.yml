name: Manual Build & Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag name for release (e.g. v2.2.0)'
        required: true
        default: 'test-build'
      
      # Checkbox to control publishing
      publish:
        description: 'Publish to GitHub Releases page?'
        type: boolean
        required: false
        default: false

# Permission to write Releases
permissions:
  contents: write

jobs:
  # =========================================================
  # JOB 1: WINDOWS
  # =========================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtpdf'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # Install Dependencies (Poppler & Tools)
      - name: Install Dependencies
        shell: cmd
        run: |
          choco install winflexbison3 7zip
          powershell -Command "Invoke-WebRequest https://github.com/oschwartz10612/poppler-windows/releases/download/v21.11.0-0/Release-21.11.0-0.zip -OutFile poppler.zip"
          7z x poppler.zip -oppoppler-21.11.0
          powershell -Command "if (Test-Path poppler-21.11.0\poppler-21.11.0) { Move-Item poppler-21.11.0\poppler-21.11.0\* poppler-21.11.0; Remove-Item poppler-21.11.0\poppler-21.11.0 }"

      - name: Build with QMake
        shell: cmd
        run: |
          mkdir build
          cd build
          qmake ..\tikzit.pro "CONFIG+=release"
          nmake

      - name: Package (Run Script)
        shell: cmd
        run: .\deploy-win.bat

      # --- VERSIONING: Rename the file (Updated for mgb-uml) ---
      - name: Rename Output
        shell: cmd
        run: move dist\mgb-uml-windows.zip dist\mgb-uml-windows-${{ github.event.inputs.release_tag }}.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MGB-UML-Windows-${{ github.event.inputs.release_tag }}
          path: dist/mgb-uml-windows-${{ github.event.inputs.release_tag }}.zip

  # =========================================================
  # JOB 2: MACOS
  # =========================================================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'
          modules: 'qtpdf'

      - name: Build with QMake
        run: |
          mkdir build
          cd build
          qmake ../tikzit.pro CONFIG+=release
          make -j$(sysctl -n hw.ncpu)

      - name: Package (Run Script)
        run: |
          chmod +x deploy-osx.sh
          ./deploy-osx.sh

      # --- VERSIONING: Rename the file (Updated for mgb-uml) ---
      - name: Rename Output
        run: mv mgb-uml-macos.dmg mgb-uml-macos-${{ github.event.inputs.release_tag }}.dmg

      - name: Upload Mac Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MGB-UML-macOS-${{ github.event.inputs.release_tag }}
          path: mgb-uml-macos-${{ github.event.inputs.release_tag }}.dmg

  # =========================================================
  # JOB 3: LINUX
  # =========================================================
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # ADDED ccache HERE vvv
          sudo apt-get install -y build-essential git pkg-config wget ca-certificates \
            flex bison qmake6 \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools qt6-pdf-dev \
            libqt6svg6-dev libpoppler-dev \
            libx11-xcb1 libxkbcommon-x11-0 libxrender1 \
            libxcb-cursor0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-randr0 libxcb-render-util0 libxcb-shape0 libxcb-shm0 \
            libxcb-sync1 libxcb-xfixes0 libxcb-xinerama0 libxcb-xkb1 \
            ccache

      # Fix for Qt6 renames in source code
      - name: Fix Source Code
        run: |
          sed -i 's/pagePointSize/pageSize/g' src/data/pdfdocument.cpp

      - name: Build with QMake
        run: |
          mkdir build
          cd build
          qmake6 ../tikzit.pro
          make -j$(nproc)

      - name: Package (Run Script)
        run: |
          chmod +x deploy-linux.sh
          ./deploy-linux.sh

      # --- VERSIONING: Rename the file (Updated for mgb-uml) ---
      - name: Rename Output
        run: mv mgb-uml-linux.AppImage mgb-uml-linux-${{ github.event.inputs.release_tag }}.AppImage

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MGB-UML-Linux-${{ github.event.inputs.release_tag }}
          path: mgb-uml-linux-${{ github.event.inputs.release_tag }}.AppImage

  # =========================================================
  # JOB 4: PUBLISH RELEASE (Conditional)
  # =========================================================
  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    
    # Only run this job if the "Publish" checkbox was checked
    if: ${{ github.event.inputs.publish == 'true' }}
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: MGB-UML-*
          merge-multiple: true

      - name: Create Release & Upload Files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: Release ${{ github.event.inputs.release_tag }}
          draft: false
          prerelease: false
          files: |
            *.zip
            *.dmg
            *.AppImage